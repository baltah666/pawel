    - name: 1 - Get Devices
      uri:
        url: "{{ netbox_url }}/dcim/devices/?name={{ inventory_hostname }}"
        method: GET
        return_content: yes
        headers:
          accept: "application/json"
          Authorization: "Token {{ netbox_token }}"
      register: device

    - name: 2 - Get Interfaces
      uri:
        url: "{{ netbox_url }}/dcim/interfaces/?device={{ inventory_hostname }}&limit=0"
        method: GET
        return_content: yes
        headers:
          accept: "application/json"
          Authorization: "Token {{ netbox_token }}"
      register: interfaces

    - name: 3 - Get IP Addresses
      uri:
        url: "{{ netbox_url }}/ipam/ip-addresses/?device={{ inventory_hostname }}"
        method: GET
        return_content: yes
        headers:
          accept: "application/json"
          Authorization: "Token {{ netbox_token }}"
      register: ip_addresses

    - name: 4 - Get Site Details
      uri:
        url: "{{ netbox_url }}/dcim/sites/?name={{ device.json.results[0]['site']['name'] }}"
        method: GET
        return_content: yes
        headers:
          accept: "application/json"
          Authorization: "Token {{ netbox_token }}"
      register: site

    - name: 5 - Get List of VLANs for Site {{ device.json.results[0]['site']['name'] }}
      uri:
        url: "{{ netbox_url }}/ipam/vlans/?site_id={{ site.json.results[0]['id'] }}"
        method: GET
        return_content: yes
        headers:
          accept: "application/json"
          Authorization: "Token {{ netbox_token }}"
      register: vlans

    - name: 6 - Create temporary folder for Device Configs
      file:
        dest: "{{ configs_directory }}/{{ inventory_hostname }}"
        state: directory

    - name: 7 - Save all registered variables to JSON files
      vars:
        save_vars:
          - device
          - interfaces
          - ip_addresses
          - site
          - vlans
      loop: "{{ save_vars }}"
      loop_control:
        loop_var: var_name
      copy:
        dest: "{{ configs_directory }}/{{ inventory_hostname }}/{{ var_name }}.json"
        content: "{{ hostvars[inventory_hostname][var_name] | to_nice_json }}"

    - name: 8 - Create configuration files
      template:
        src: "templates/{{ platforms[0] }}.j2"
        dest: "{{ configs_directory }}/{{ inventory_hostname }}/{{ inventory_hostname }}.conf"

    - name: 9 - JUNOS BONUS PLAY!! - Create Junos config using Set Commands
      template:
        src: "templates/{{ platforms[0] }}-set.j2"
        dest: "{{ configs_directory }}/{{ inventory_hostname }}/{{ inventory_hostname }}.set"
      when: platforms[0] == 'juniper-junos'
