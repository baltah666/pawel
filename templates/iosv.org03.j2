#jinja2: lstrip_blocks: True
no service pad
service tcp-keepalives-in
service tcp-keepalives-out
service timestamps debug datetime msec localtime show-timezone year
service timestamps log datetime msec localtime show-timezone year
service password-encryption
service linenumber
service compress-config
service sequence-numbers
no platform punt-keepalive disable-kernel-core
!
hostname {{ device.json.results[0]['name'] }}
!
boot-start-marker
boot-end-marker
!
vrf definition Mgmt-intf
 !
 address-family ipv4
 exit-address-family
 !
 address-family ipv6
 exit-address-family
!
aaa new-model
no ip bootp server
spanning-tree extend system-id
redundancy
 mode none
lldp run
!
{% for intf in interfaces.json.results %}
interface {{ intf.name }}
  {% if intf.description %}
  description {{ intf.description }}
  {% endif %}

  {# ---- L3 case: IP address assigned ---- #}
  {% set has_ip = false %}
  {% for ip in ip_addresses.json.results %}
    {% if ip.assigned_object.name == intf.name %}
  ip address {{ ip.address.split('/')[0] }} {{ ip.address | ansible.utils.ipaddr('netmask') }}
      {% set has_ip = true %}
    {% endif %}
  {% endfor %}

  {# ---- L2 case: Access/Trunk ---- #}
  {% if intf.mode and intf.mode.value == "access" %}
  switchport mode access
  switchport access vlan {{ intf.untagged_vlan.vid }}
  {% elif intf.mode and intf.mode.value == "tagged" %}
  switchport mode trunk
    {% if intf.tagged_vlans %}
  switchport trunk allowed vlan {{ intf.tagged_vlans | map(attribute='vid') | join(',') }}
    {% endif %}
  {% endif %}

  no shutdown
!
{% endfor %}
!
line con 0
 logging synchronous
 stopbits 1
line aux 0
 stopbits 1
end
